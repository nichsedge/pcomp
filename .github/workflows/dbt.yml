name: Run dbt

on:
  schedule:
    - cron: '0 1 * * 2'  # Dedup at 1 AM every Tuesday
  workflow_dispatch:  # Allows manual triggering
  push:
    paths:
      - 'dbt_comp/**'  # Trigger on push to any file in the dbt_comp folder

env:
  DBT_PROFILES_DIR: ./dbt_pcomp
  GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
  GCP_CREDENTIALS_FILE: ./dbt_pcomp/dbt-service-account.json

jobs:
  dbt-run:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"

    - name: Sync dependencies
      run: uv sync

    - name: Service account key to json file 
      run: 'echo "$GCP_CREDENTIALS" > "$GCP_CREDENTIALS_FILE"'
      shell: bash

    - name: Run dbt
      run: |
        uv run dbt run --project-dir ./dbt_pcomp
